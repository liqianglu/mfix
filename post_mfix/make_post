#!/bin/bsh -f
#
# POST_MFIX script file for executing 'make'
# M. Syamlal/P.Nicoletti                   9-27-95
#------------------------------------------------------------------------
# For compiling post_mfix the ../model directory must exist.
#
    if test -f machine.f
    then
    chmod +w machine.f
    else
    echo
    fi

    set `uname -s` ; opsys=$1

#------------------------------------------------------------------------
#  Check if the system is a Linux system, if yes then ask the user which 
#  compiler to use    
#
    if test $opsys = "Linux"
    then
       echo
       echo
       echo "Linux system detected, please select compiler"
       echo
       echo "Post_mfix Compilation directives available for following compilers:"
       echo " - Intel Linux Fortran Compiler (ifc)"
       echo " - Portland Group Linux Fortran Compiler (pgf90)"
       echo -n "Do you want to compile with Intel Linux F90 Compiler? (y/n) [yes] "
       read lnx_compiler
       case $lnx_compiler in
         y|Y ) 
	   echo "Intel Linux Fortran Compiler selected"
	   opsys="Linux_ifc"
           ;;
         n|N )
	   echo "Portland Group Linux Fortran Compiler selected" 	      
	   opsys="Linux_pgi"
           ;; 
         *)
           echo "Intel Linux Fortran Compiler selected"
	   opsys="Linux_ifc"
           ;;
       esac    
    else
       echo  
    fi
    
    case $opsys in

	OSF1)
            mach_file="OSF1.F"

            FORTRAN_CMD=f90
            LINK_CMD=f90
            libs_d="-lcxmlp -lmpi -lelan"
            libs="-lcxmlp -lmpi -lelan"

            OBJ_EXT=o
            FORTRAN_EXT=f
            omp="-omp"
            compile_d="-c -I. -I$mpi_include -C -trapuv -g -free -nowarn -assume byterecl -convert big_endian "
            link_d="-C -g -nowarn -assume byterecl -convert big_endian"

            compile="-c -I. -I$mpi_include -O5 -free -nowarn -assume byterecl -convert big_endian "
            compile2="-c -I. -I$mpi_include -O5 -free -nowarn -assume byterecl -convert big_endian "
            link="-O5 -nowarn -assume byterecl -convert big_endian"
            MODULE_CODE=1
            ;;

	AIX)
            mach_file="AIX.F"

	    case $dmp_version in
	      y|Y )
	    		FORTRAN_CMD=mpxlf90_r
	    		LINK_CMD=mpxlf90_r
            	;;
              *)
	    		FORTRAN_CMD=xlf90_r
	    		LINK_CMD=xlf90_r
            	;;
            esac

	    libs_d="-lblas "
	    libs="-lblas -lesslp2_r"

	    OBJ_EXT=o
	    FORTRAN_EXT=f

#	    =============================
#	    use mpxlf90_r or xlf90_r
#	    for thread safe code
#	    =============================
	    omp="-qsmp=omp -qsmp=noauto -qnosave "

#	    =================================
#	    the module directory cannot be on
#	    a GPFS parallel file system
#	    =================================

            compile_common="-c -q32 -bmaxstack:2000000000 -bmaxdata:2000000000 -c -I.  -freeform"
	    compile_d="-C -g -qinitauto=FF -qflttrap -freeform $compile_common"
	    link_d="$compile_d"

            compile=" -O3 -qhot -qstrict  -qarch=pwr3 -qtune=pwr3 -qcache=auto $compile_common"
	    compile2="$compile"
            link="-O3 -qstrict -qarch=pwr3 -q32 -bmaxstack:2000000000 -bmaxdata:2000000000
-qtune=pwr3 -qcache=auto "

 	    MODULE_CODE=1
            ;;



    Linux_pgi)
            echo
            echo "Compiling for Linux computer (Portland group)"
            echo	    
	    
            if test -f COMPILED.FOR.LINUX.PG
            then
	        echo
            else
                /bin/cp -f ../model/LINUX.F machine.f
                /bin/rm -f *.o
                /bin/rm -f COMPILED.FOR.*
                touch COMPILED.FOR.LINUX.PG
            fi
	    
	    
            FORTRAN_CMD=pgf90
            LINK_CMD=pgf90
	       
	    
            OBJ_EXT=o
            FORTRAN_EXT=f
            compile_d="-c -Mfreeform -Mnosave -Mrecursive -Mreentrant -g -byteswapio"
            link_d="-g"
            compile="-c -Mfreeform -Mnosave -Mrecursive -Mreentrant -byteswapio"
            link=" "
            MODULE_CODE=1

            ;;

    Linux_ifc)
            echo
            echo "Compiling for Linux computer (Intel Linux Compilers (ifc))"
            echo	    
	    
            if test -f COMPILED.FOR.LINUX.IFC
            then
	        echo
            else
                cp ../model/LINUX_intel.F machine.f
                rm *.o
                rm COMPILED.FOR.*
                touch COMPILED.FOR.LINUX.IFC
            fi
	    
	    
            FORTRAN_CMD=ifc
            LINK_CMD=ifc 
	       
	    
            OBJ_EXT=o
            FORTRAN_EXT=f

           #-----------
	   # Check if Intel Linux compiler portability library is accessible?
	   #-----------
            echo
            echo "checking for Intel compiler portability library, PEPCF90" 
	    echo "in the default directory /opt/intel/compiler70/ia32/lib"
            if test -f "/opt/intel/compiler70/ia32/lib/libPEPCF90.a"
            then
	        echo
              #  echo -n "PEPCF90 library found under /opt/intel/compiler70/ia32/lib"
		intel_lib="/opt/intel/compiler70/ia32/lib"
            else
	        intel_dir="/opt/intel"
	        echo  "Library not found. Enter the directory "
                echo -n "where Intel Linux compiler is installed [e.g. /opt/intel]: "
                   read intel_dir
  	         intel_lib="$intel_dir/compiler70/ia32/lib"  

 	         if test -d "$intel_lib"
	         then
                   echo
	         else
	           echo "Directory $intel_lib not found"
	           exit
	         fi

            fi

	    
            compile_d="-g -c -FR -xK -w "
            link_d="-L$intel_lib -lPEPCF90 "
            compile="-c -O3 -w -w95 -i_dynamic -ip -FR"
            link="-L$intel_lib -lPEPCF90"
            MODULE_CODE=0

            ;;
	    
      sn6301)
            echo
            echo "Compiling for Cray T3E"
            echo "\nPlease wait . . ."
            echo

            if test -f COMPILED.FOR.CRAYT3EF90
            then
                echo
            else
                /bin/cp -f ../model/CRAYT3E.F machine.f
                /bin/rm -f *.o
                /bin/rm -f *.a
                /bin/rm -f COMPILED.FOR.*
                touch COMPILED.FOR.CRAYT3EF90
            fi


            FORTRAN_CMD=f90
            LINK_CMD=f90

            OBJ_EXT=o
            FORTRAN_EXT=f
            compile_d="-c -g -f free -d p -e mui -eA -O ieeeconform -M 801"
            link_d="-lapp"

            compile="-c -g -f free -d p -e mui -eA -O ieeeconform -M 801"
            compile2="-c  -g -f free -d p -e mui -eA -eZ -F -DT3E -O ieeeconform -M 801"
            link="-lapp"
            MODULE_CODE=0
            ;;

      IRIX64) 
            echo
            echo "Compiling for SGI IRIX64 computer"
            echo
	    
            if test -f COMPILED.FOR.IRIX64F90
            then
	        echo
            else
                /bin/cp -f ../model/IRIXF90.F machine.f
                /bin/rm -f *.o
		/bin/rm -f *.a
                /bin/rm -f COMPILED.FOR.*
                touch COMPILED.FOR.IRIX64F90
            fi
	    
	    
            FORTRAN_CMD=f90
            LINK_CMD=f90
	       	    
            OBJ_EXT=o
            FORTRAN_EXT=f
            compile_d="-c -I../model -g -C -trapuv -freeform"
            link_d="-g -C -trapuv"
            compile="-c -I../model -n32 -g -freeform"
            link="-n32 -g"
            MODULE_CODE=0

            ;;
	    
      ULTRIX) 
            echo
            echo "Compiling for DEC ULTRIX computer"
            echo
	    
            if test -f COMPILED.FOR.ULTRIX
            then
	        echo
            else
                /bin/cp -f ../model/ULTRIX.F machine.f
                /bin/rm -f *.o
		/bin/rm -f *.a
                /bin/rm -f COMPILED.FOR.*
                touch COMPILED.FOR.ULTRIX
            fi
	    
	    
            FORTRAN_CMD=f90
            LINK_CMD=f90
     
            OBJ_EXT=o
            FORTRAN_EXT=f
            compile_d="-c -g -freeform -convert big_endian"
            link_d="-g -convert big_endian"
            compile="-c -O2 -freeform -convert big_endian"
            link="-O2 -convert big_endian"
            MODULE_CODE=0

            ;;
             

    CYGWIN32_NT)
            echo
            echo "Compiling for NT computer (Portland group)"
            echo	    
	    
            if test -f COMPILED.FOR.CYWIN32_NT.PG
            then
	        echo
            else
                /bin/cp -f ../model/PGNT.F machine.f
                /bin/rm -f *.o
                /bin/rm -f COMPILED.FOR.*
                touch COMPILED.FOR.CYWIN32_NT.PG
            fi
	    
	    
            FORTRAN_CMD=pgf90
            LINK_CMD=pgf90
	       	    
            OBJ_EXT=o
            FORTRAN_EXT=f
            compile_d="-c -Mfreeform -Mnosave -Mrecursive -Mreentrant -O0 -byteswapio"
            link_d=" "
            compile="-c -Mfreeform -Mnosave -Mrecursive -Mreentrant -O0 -byteswapio"
            link=" "
            MODULE_CODE=1

            ;;
	    
    CYGWIN_NT-4.0)
            echo
            echo "Compiling for NT computer (Portland group)"
            echo	    
	    
            if test -f COMPILED.FOR.CYWIN_NT-4.0.PG
            then
	        echo
            else
                /bin/cp -f ../model/PGNT.F machine.f
                /bin/rm -f *.o
                /bin/rm -f COMPILED.FOR.*
                touch COMPILED.FOR.CYWIN_NT-4.0.PG
            fi
	    
	    
            FORTRAN_CMD=pgf90
            LINK_CMD=pgf90
	       	    
            OBJ_EXT=o
            FORTRAN_EXT=f
            compile_d="-c -Mfreeform -Mnosave -Mrecursive -Mreentrant -O0 -byteswapio"
            link_d=" "
            compile="-c -Mfreeform -Mnosave -Mrecursive -Mreentrant -O0 -byteswapio"
            link=" "
            MODULE_CODE=1

            ;;
	    
   
   
   
      *) echo "no support for operating system: $opsys"
         echo 
	 echo "modify  make_post   to add support"
	 echo
         exit ;;
   esac

echo " "

#Prepare for the current machine
    mach_check="COMPILED.WITH.$mach_file"
    if test -f $mach_check
    then
       echo
    else
       chmod +w machine.f
	/bin/cp -f ../model/$mach_file machine.f
	/bin/rm -f *.o *.a *.mod *.exe
	/bin/rm -f COMPILED.WITH.*
	touch $mach_check
    fi

#
#------------------------------------------------------------------------
# delete *.o *.mod and *.a files from model directory
echo "IMPORTANT: execute this makefile by typing \"sh make_post\" "
echo
echo
echo -n "Object files (*.o, *.mod, *.a) in mfix/model will be deleted. Continue? (y/n) [no] "
read delete_files
  case $delete_files in
  y|Y )
    echo "deleting files . . ."
    /bin/rm -f ../model/*.o ../model/*.mod ../model/*.a
    /bin/rm -f *.o *.mod
    ;;
  *)
    exit
    ;;
  esac

  echo
  echo "Please wait . . ."


#
#------------------------------------------------------------------------
#
#  Create a backup of the function.inc in the model directory and copy the
#  function.inc from the post_mfix directory to the model directory

#      Is there default file Mfix/model directory?
       if test -r "../model/function.0inc"
       then
          do_nothing="ok"
      
       else
#        Mfix/model directory does not have a default file. create one.
         /bin/cp -f "../model/function.inc" "../model/function.0inc"
       fi
       /bin/cp -f "./function.inc" "../model/function.inc"

#------------------------------------------------------------------------
#
    FORT_FLAGS="$compile"
    LINK_FLAGS="$link"
#
#
  export FORT_FLAGS
  export LINK_FLAGS
  export LIB_FLAGS
  export OBJ_EXT
  export FORTRAN_EXT
  export FORTRAN_CMD
  export LINK_CMD

 /bin/cp -f -p ../model/ep_s1.inc .
 /bin/cp -f -p ../model/ep_s2.inc .
 /bin/cp -f -p ../model/fun_avg1.inc .
 /bin/cp -f -p ../model/fun_avg2.inc .
 /bin/cp -f -p ../model/s_pr1.inc .
 /bin/cp -f -p ../model/s_pr2.inc .
 /bin/cp -f -p ../model/namelist.inc .
 /bin/cp -f -p ../model/sc_p_g1.inc .
 /bin/cp -f -p ../model/sc_p_g2.inc .

      
 case $MODULE_CODE in

      0)
         make -f post_u.make
         ;;

      1)  
         make -f post_l.make
         ;;

 esac
 
 if test $? = 0
 then
    echo
    echo 
    echo "********************************************"
    echo "* Compilation successful: post_mfix created*"
    echo "********************************************"
    echo 
 else
    echo
    echo
    echo "*** File post_mfix NOT created."
    echo 
 fi
 
# Restore the function.inc file in the model directory
  /bin/mv -f "../model/function.0inc" "../model/function.inc"

 chmod +w ep_s1.inc
 chmod +w ep_s2.inc
 chmod +w fun_avg1.inc
 chmod +w fun_avg2.inc
 chmod +w s_pr1.inc
 chmod +w s_pr2.inc
 chmod +w namelist.inc
 chmod +w sc_p_g1.inc
 chmod +w sc_p_g2.inc

 /bin/rm -f ep_s1.inc
 /bin/rm -f ep_s2.inc
 /bin/rm -f fun_avg1.inc
 /bin/rm -f fun_avg2.inc
 /bin/rm -f s_pr1.inc
 /bin/rm -f s_pr2.inc
 /bin/rm -f namelist.inc
 /bin/rm -f sc_p_g1.inc
 /bin/rm -f sc_p_g2.inc
